name: CI Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_call:

permissions:
  contents: read

jobs:
  code-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version-file: .python-version

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - uses: go-task/setup-task@v1

      - name: Install project dependencies
        run: task install

      - name: Code checks
        run: task code:check

  unit-tests:
    runs-on: ubuntu-latest
    needs: code-checks
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version-file: .python-version

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - uses: go-task/setup-task@v1

      - name: Install project dependencies
        run: task install

      - name: Unit tests
        run: |
          export COVERAGE_FILE=coverage.unit
          uv run pytest -q tests/sdx_core --cov=sdx_core

      - name: Upload coverage handoff
        uses: actions/upload-artifact@v6
        with:
          name: coverage-unit
          path: |
            coverage.unit
          retention-days: 7
          if-no-files-found: error

  coverage-report:
    runs-on: ubuntu-latest
    needs:
      - unit-tests
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version-file: .python-version

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - uses: go-task/setup-task@v1

      - name: Install project dependencies
        run: task install

      - name: Download unit coverage handoff
        uses: actions/download-artifact@v6
        with:
          name: coverage-unit
          path: coverage-unit

      - name: Combine coverage data
        run: uv run coverage combine coverage-unit/coverage.unit

      - name: Build coverage reports
        run: |
          uv run coverage xml
          uv run coverage html

      - name: Coverage summary
        run: |
          echo "## Coverage Summary" >> "$GITHUB_STEP_SUMMARY"
          uv run coverage report --format=markdown >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov
          retention-days: 30
          if-no-files-found: error
